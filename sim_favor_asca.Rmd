---
title: "sim_favor_asca"
author: "zhu"
date: "11/12/2018"
output:
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = FALSE,warning = FALSE,results = F)
```
```{r,echo=T}
####pipeline#####
i=2#treatment
j=6#time
r=4#replicate
time=c(0,1,2,3,4,5)#time points
```
White noise is N(0,0.2)
```{r trend}
set.seed(999)
# #y1 <- 0.01*time+0.01*time^2+0.01*time^3+0.01*time^4
# ctrl <- 0.01*time+0.1
# tre1 <- -0.01*time-0.1
# fluctuate <- c(2,-2,2,-2,2,-2)
# notrend <- rep(0,6)
# y1 <- c(notrend)
# y12 <- fluctuate
# 
# y2 <- c(notrend)
# y22 <- fluctuate
# 
# y3 <- c(notrend)
# y32 <- fluctuate

rep <- 4
sd <- 0.2
ctrl <- 0.01*time+0.1
tre1 <- -0.01*time-0.1
fluctuate <- list(2,-2,2,-2,2,-2)
notrend <- rep(list(0),6)
ctrl <- notrend
tre1 <- fluctuate
tre2 <- fluctuate

trend1 <- append(ctrl,tre1)
trend2 <- append(ctrl,tre2)
trend3 <- append(ctrl,tre2)
trend4 <- append(ctrl,ctrl)
ftrs_in_pat <- list(30,30,1,100)
pat_names <- list('one','two','three','flat')

source('utils.R')
simulation <- create.simulation(pat_names.list = pat_names,ftrs_in_pat,rep,sd,trend1,trend2,trend3,trend4)
# simulation <- generate_data.same_var(p1 = 10,p2 = 10,p3 = 1,neg = 35,var=0.2)
df.final <- simulation$df
groups <- simulation$groups
```
```{r plot raw data metabolite one}
trend.toplot <- data.frame(replicate=rep(1:(i*j),each=r),time=rep(time,each=r),treatment=factor(rep(1:i,each=j*r)),metabolite=df.final[5,])
ggplot(trend.toplot,aes(x=time,y=metabolite,color=treatment))+
  geom_point()+
  stat_summary(fun.y = mean,geom = 'line')+
  labs(title = 'pattern')
```
```{r plot raw data metabolite two}
trend.toplot <- data.frame(replicate=rep(1:(i*j),each=r),time=rep(time,each=r),treatment=factor(rep(1:i,each=j*r)),metabolite=df.final[31,])
ggplot(trend.toplot,aes(x=time,y=metabolite,color=treatment))+
  geom_point()+
  stat_summary(fun.y = mean,geom = 'line')+
  labs(title = 'flat')
```

There are 21 metabolites with the differential expression shown in the above linear function and 200 metabolites with flat expression.

```{r check correlation,include=F}
#cov(t(df.final[c(1,11,21,31),]))
knitr::kable(cor(t(df.final[19:24,])),caption = 'correlations')
```


```{r asca-gene design matrix and fit, message=F, warning=F}
#design matrix
mx <- asca.design.matrix(i,j,r,time)
#fit model
type=1
Fac=c(1,1,2,1)
asca.fit <- ASCA.2f(X = t(df.final),Designa = mx$j, Designb = mx$i,type = type, Fac = Fac,showvar = F,showscree = T)
print(asca.fit$Model.bab$var.exp)
```

Screeplot shows that 1-2 PCs to be included for submodel b.ab(treatment+interaction). Here 2 pcs were selected

```{r screeplot of submodel ab,eval=F}
ab <- asca.fit$Model.ab$data
plot(rep(1:6,2),ab[,1])
```

```{r leverage and spe plot}
asca.fitted <- fitted(df.final,asca.fit,groups,2,which_leverage = ASCA.2f_leverage)
asca.fitted.original <- fitted(df.final,asca.fit,groups,2,which_leverage = ASCA.2f)
leverages_spe <- plot.leverage_spe(asca.fitted,0.2)
```

With 2 PCs selected, 10 out of 12 differential expressed metabolites corrected identified, fall into right-bottom quadrant.

```{r score plot}
plot.submodels_score(asca.fit,i,j)
```

score plot of submodel b.ab shows a clear seperation between treatment1 and treatment2. 

```{r loading plot}
plot.submodels_loading(asca.fit,groups)
```

```{r residual plot}
residuals <- asca.fit$Model.bab$data-(asca.fit$Model.bab$scores%*%t(asca.fit$Model.bab$loadings))
matplot(residuals[,leverages_spe[[2]]],type='l',col = 'red')
matplot(residuals[,-leverages_spe[[2]]],type = 'l',col = 'grey',add=T)
```


loading plot shows differentially expressed metabolites making high contribution in this pc.

```{r masigpro design matrix and fit,results=T}
masigpro.design <- design_matrix(i,j,r,time)
design <- make.design.matrix(edesign = masigpro.design,degree = 4)
edesign <- design$edesign
colnames(df.final) <- rownames(edesign)

masigpro.fit <- maSigPro(df.final,masigpro.design,degree=4,step.method = 'backward')
toplot <- rownames(masigpro.fit$summary)
masigpro.fit$summary
```

However, masigpro could not identify any significant abnormal metabolites.
```{r plot raw data metabolite2,eval=F}
trend.toplot <- data.frame(replicate=rep(1:(i*j),each=r),time=rep(time,each=r),treatment=factor(rep(1:i,each=j*r)),metabolite=df.final[20,])
ggplot(trend.toplot,aes(x=time,y=metabolite,color=treatment))+
  geom_point()+
  stat_summary(fun.y = mean,geom = 'line')
```
```{r}
source('utils.R')
plots <- plot.submodels(asca.fitted,asca.fit,Fac)
```

