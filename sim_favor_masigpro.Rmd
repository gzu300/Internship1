---
title: "sim_favor_masigpro"
author: "zhu"
date: "11/12/2018"
output:
  pdf_document: default
  word_document: default
---

# MaSigpro plots the trend of every single variable across time. So we are able to see such trend immediately. However for ASCA due to its way of analysation, we could see how the trend is going. Also ASCA tends to describe major trend better. Minor trend would be ignored.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = FALSE,warning = FALSE)
```
```{r}
source('utils.R')


####pipeline#####
i=2#treatment
j=6#time
r=4#replicate
time=c(0,1,2,3,4,5)#time points
#y1 <- 0.01*time+0.01*time^2+0.01*time^3+0.01*time^4
ctrl <- -0.1*(time-3)^2+0.5
tre1 <- c(0,1.5,-1.5,1.5,-1.5,0)
tre2 <- -0.2*((time-2.5)^2)+0.5
tre3 <- c(-0.8,0,0.8,0.8,0,-0.8)
notrend <- rep(0,6)
y1 <- c(notrend)
y12 <- c(notrend)

y2 <- c(notrend)
y22 <- c(notrend)

y3 <- c(tre3-c(0.1,0.2,0.2,0.2,0.2,0.3))
y32 <- c(tre3)

set.seed(1)
simulation <- generate_data.same_var(p1 = 10,p2 = 10,p3 = 1,neg = 35,var=0.2)

df.final <- simulation$df
groups <- simulation$groups
```
```{r plot raw data metabolite one}
trend.toplot <- data.frame(replicate=rep(1:(i*j),each=r),time=rep(time,each=r),treatment=factor(rep(1:i,each=j*r)),metabolite=df.final[5,])
ggplot(trend.toplot,aes(x=time,y=metabolite,color=treatment))+
  geom_point()+
  stat_summary(fun.y = mean,geom = 'line')+
  labs(title = 'pattern "one"')
```

There are 31 metabolites with differential expressed metaboiltes. there are only 30 flat matebolites.
```{r plot raw data metabolite two,include=F}
trend.toplot <- data.frame(replicate=rep(1:(i*j),each=r),time=rep(time,each=r),treatment=factor(rep(1:i,each=j*r)),metabolite=df.final[20,])
ggplot(trend.toplot,aes(x=time,y=metabolite,color=treatment))+
  geom_point()+
  stat_summary(fun.y = mean,geom = 'line')+
  labs(title = 'pattern "two"')
```
```{r plot raw data metabolite three,include=F}
trend.toplot <- data.frame(replicate=rep(1:(i*j),each=r),time=rep(time,each=r),treatment=factor(rep(1:i,each=j*r)),metabolite=df.final[21,])
ggplot(trend.toplot,aes(x=time,y=metabolite,color=treatment))+
  geom_point()+
  stat_summary(fun.y = mean,geom = 'line')+
  labs(title = 'pattern "three"')
```



```{r check correlation,include=F}
#cov(t(df.final[c(1,11,21,31),]))
knitr::kable(cor(t(df.final[18:23,])),caption = 'correlations')
```



```{r masigpro design matrix and fit,results=F}
masigpro.design <- design_matrix(i,j,r,time)
design <- make.design.matrix(edesign = masigpro.design,degree = 4)
dis <- design$dis
edesign <- design$edesign
colnames(df.final) <- rownames(edesign)

masigpro.fit <- maSigPro(df.final,masigpro.design,degree=4,step.method = 'forward')
toplot <- rownames(masigpro.fit$summary)
```
```{r masigpro summary}
print(masigpro.fit$summary)
```

all the patterns are identified by masigpro.

```{r asca-gene design matrix and fit, message=F, warning=F}
#design matrix
mx <- asca.design.matrix(i,j,r,time)
#fit model
type=1
Fac=c(1,1,2,1)
asca.fit <- ASCA.2f(X = t(df.final),Designa = mx$j, Designb = mx$i,type = type, Fac = Fac,showvar = F,showscree = T)
#print(asca.fit$Model.bab$var.exp)
```

Screeplot shows that 1 PC to be included for submodel b.ab(treatment+interaction).

```{r leverage and spe plot}
fitted <- fitted(df.final,asca.fit,groups,2,ASCA.2f_leverage)
plot.leverage_spe(fitted,0.2)
```

ÃŸ



