---
title: "sim_favor_masigpro"
author: "zhu"
date: "11/12/2018"
output:
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = FALSE,warning = FALSE)
```
```{r}
source('main.R')
```
```{r data}
set.seed(999)
####pipeline#####
i=2#treatment
j=6#time
r=4#replicate
time=c(0,1,2,3,4,5)#time points
#y1 <- 0.01*time+0.01*time^2+0.01*time^3+0.01*time^4
ctrl <- 0.4*time
tre1 <- -0.4*time
tre2 <- -0.2*((time-2.5)^2)+0.5
tre3 <- c(0,0.3,1,0.4,0.6,2)
notrend <- rep(0,6)
y1 <- c(notrend)
y12 <- c(tre1)

y2 <- c(notrend)
y22 <- c(tre1)

y3 <- c(notrend)
y32 <- c(tre1)
#y12 <- 0.01*time^2

#y2 <- -time

#y3 <- c(-2,-1,0,0,1,2)
# y1 <- c(0,1,2,3,4,5)
#y32 <- 0.01*time^2
#y3 <- -0.01*time^3

#total of 100 metabolites(columns)
#total of 2*5*4=40 rows

simulation <- generate_data.nocorrelation()
df.final <- simulation$df
groups <- simulation$groups
```
```{r plot raw data metabolite one}
trend.toplot <- data.frame(replicate=rep(1:(i*j),each=r),time=rep(time,each=r),treatment=factor(rep(1:i,each=j*r)),metabolite=df.final[5,])
ggplot(trend.toplot,aes(x=time,y=metabolite,color=treatment))+
  geom_point()+
  stat_summary(fun.y = mean,geom = 'line')+
  labs(title = 'pattern "one"')
```

There are 31 metabolites with differential expressed metaboiltes. there are only 30 flat matebolites.
```{r plot raw data metabolite two,include=F}
trend.toplot <- data.frame(replicate=rep(1:(i*j),each=r),time=rep(time,each=r),treatment=factor(rep(1:i,each=j*r)),metabolite=df.final[20,])
ggplot(trend.toplot,aes(x=time,y=metabolite,color=treatment))+
  geom_point()+
  stat_summary(fun.y = mean,geom = 'line')+
  labs(title = 'pattern "two"')
```
```{r plot raw data metabolite three,include=F}
trend.toplot <- data.frame(replicate=rep(1:(i*j),each=r),time=rep(time,each=r),treatment=factor(rep(1:i,each=j*r)),metabolite=df.final[21,])
ggplot(trend.toplot,aes(x=time,y=metabolite,color=treatment))+
  geom_point()+
  stat_summary(fun.y = mean,geom = 'line')+
  labs(title = 'pattern "three"')
```



```{r check correlation,include=F}
#cov(t(df.final[c(1,11,21,31),]))
knitr::kable(cor(t(df.final[c(1,2,11,12,21,22,23),])),caption = 'correlations')
```



```{r masigpro design matrix and fit,results=F}
masigpro.design <- design_matrix(i,j,r,time)
design <- make.design.matrix(edesign = masigpro.design,degree = 4)
dis <- design$dis
edesign <- design$edesign
colnames(df.final) <- rownames(edesign)

masigpro.fit <- maSigPro(df.final,masigpro.design,degree=4,step.method = 'backward')
toplot <- rownames(masigpro.fit$summary)
```
```{r masigpro summary}
print(masigpro.fit$summary)
```

all the patterns are identified by masigpro.

```{r asca-gene design matrix and fit, message=F, warning=F}
#design matrix
mx <- asca.design.matrix(i,j,r,time)
#fit model
type=1
Fac=c(1,2,1,1)
asca.fit <- ASCA.2f(X = t(df.final),Designa = mx$j, Designb = mx$i,type = type, Fac = Fac,showvar = F,showscree = T)
#print(asca.fit$Model.bab$var.exp)
```

Screeplot shows that 1 PC to be included for submodel b.ab(treatment+interaction).

```{r leverage and spe plot}
plot.leverage_spe(df.final,asca.fit,groups,R=20)
```

With 1 PCs selected, all the patterns are within the leverage limits.

```{r score plot}
plot.submodels_score(asca.fit,i,j)
```

score plot of submodel b.ab shows a clear seperation between treatment1 and treatment2. 

```{r look at extra pcs,include=F}
Fac.extrapc=c(1,2,3,1)
asca.fit_extrapc <- ASCA.2f(X = t(df.final),Designa = mx$j, Designb = mx$i,type = type, Fac = Fac.extrapc,showvar = F,showscree = F)
```
```{r loading plot}
plot.submodels_loading(asca.fit,groups)
```


```{r leverage spe extra pc,include=F}
plot.leverage_spe(df.final,asca.fit_extrapc,groups,10)
```


```{r score plot extra pc,include=F}
plot.submodels_score(asca.fit_extrapc,i,j)
```


```{r residual plot,include=F}
residuals <- asca.fit_extrapc$Model.bab$data-(asca.fit_extrapc$Model.bab$scores%*%t(asca.fit_extrapc$Model.bab$loadings))
matplot(residuals[,21],type='l',col = 'red')
matplot(residuals[,-21],type = 'l',col = 'black',add=T)
```

```{r unormed loading}
a <- plot.leverage_spe(df.final,asca.fit,groups,10)
```
```{r}
b <- plot.leverage_spe_original(df.final,asca.fit,groups,10)
```

```{r}
asca.fit.normedld <- ASCA.2f_leverage(X = t(df.final),Designa = mx$j, Designb = mx$i,type = type, Fac = Fac.extrapc,showvar = F,showscree = T)
plot.submodels_loading(asca.fit.normedld,groups)
```



